// Generated by CoffeeScript 1.10.0
(function() {
  $(function() {
    var editor = ace.edit("editor");
    var keys = {};
    editor.setTheme("ace/theme/twilight");
    editor.getSession().setMode("ace/mode/ruby");
    document.getElementById('editor').style.fontSize = '14px';

    var compute_result = function() {
      var code = editor.session.getDocument().getAllLines();
      display_pending();

      $.ajax({
        url: '/editors/spec',
        type: 'POST',
        data: {
          'code': code
        },
        success: function(response) {
          keys = {};
          print_result(response.result);
        }
      });
    };

    var display_pending = function() {
      $("#result #body").text("處理中...");
    };

    var print_result = function(text) {
      $("#result #body").html(text);
      $("#rspec-header").hide();
    };

    var update_code = function(text) {
      editor.setValue(text, 1);
    };

    compute_result();
    $("#tip").hide();

    $("#send").click(function() {
      $("#tip").show();
      compute_result();
    });

    $("#editor").keydown(function(key) {
      keys[key.which] = true;
      if (keys.hasOwnProperty(13) === true && keys.hasOwnProperty(91) === true) {
        $("#tip").hide();
        compute_result();
      }
      $("#editor").keyup(function(key) {
        delete keys[key.which];
      });
    });

    var set_realtime = function(){
      editor.setReadOnly(false);
      var code   = editor.session.getDocument().getAllLines();
      var result = $("#result #body").html();
      $.ajax({
        url: '/editors/set_realtime',
        type: 'POST',
        data: {
          'code': code,
          'result': result
        },
        success: function(response) {
        }
      });
    };

    var get_realtime = function(){
      editor.setReadOnly(true);
      $.ajax({
        url: '/editors/realtime',
        type: 'GET',
        success: function(response) {
          editor.setValue(response.code, 1);
          print_result(response.result);
          update_code(response.code);
        }
      });
    };

    var observer = false;
    var real = setInterval(function(){
      if(observer){
        get_realtime();
      }else{
        set_realtime();
      };
    }, 1000);

    $("#observer").click(function(){
      if(observer == false){
        observer = true;
        $(".header.mode span").text("觀察模式");
        $("#observer").addClass("btn-warning");
        $("#observer").removeClass("btn-success");
      }else{
        observer = false;
        $(".header.mode span").text("寫作模式");
        $("#observer").addClass("btn-success");
        $("#observer").removeClass("btn-warning");
      };
    });

  });
}).call(this);
